<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      integrity="sha384-tViUnnbYAV00FLIhhi3v/dWt3Jxw4gZQcNoSCxCIFNJVCx7/D55/wXsrNIRANwdD"
      crossorigin="anonymous"
    />
    <title>FastAPI Starter ⚡</title>
  </head>

  <body class="min-h-screen flex items-center justify-center px-4">
    <main class="w-full max-w-md">
      <section
        class="space-y-6 border border-neutral-700/40 rounded-3xl p-10 shadow-2xl flex flex-col text-center bg-black/20 backdrop-blur"
        x-data="app()"
      >
        <div class="space-y-3">
          <div class="text-5xl">
            <i class="bi bi-lightning-charge-fill"></i>
          </div>

          <h1 class="!mb-0 text-2xl font-bold tracking-tight">FastAPI ⚡</h1>

          <p class="text-sm opacity-70">Async background report generator</p>
        </div>

        <div class="border-t border-neutral-700/40 pt-6 space-y-4 text-left">
          <label class="text-xs opacity-70">Duration (seconds)</label>

          <input
            type="number"
            min="1"
            x-model="duration"
            class="w-full"
            placeholder="Duration in seconds"
          />

          <button
            @click="startReport"
            :disabled="loading"
            class="w-full flex items-center justify-center gap-2 font-semibold py-3 rounded-xl transition active:scale-[0.98] disabled:opacity-60"
          >
            <i
              class="bi"
              :class="loading ? 'bi-arrow-repeat animate-spin' : 'bi-file-earmark-bar-graph-fill'"
            ></i>
            <span x-show="!loading">Generate Report</span>
            <span x-show="loading">Processing...</span>
          </button>

          <div
            x-show="taskId"
            class="text-xs opacity-60 border border-neutral-700/40 rounded-lg p-3 bg-black/20 break-all"
          >
            Task ID:
            <span class="font-mono" x-text="taskId"></span>
          </div>

          <div class="text-center text-sm font-semibold" x-text="state"></div>

          <div
            x-show="state === 'STARTED'"
            class="text-yellow-400 text-center flex items-center justify-center gap-2"
          >
            <span
              class="inline-block w-2 h-2 rounded-full bg-yellow-400 animate-pulse"
            ></span>
            Task is running...
          </div>

          <div x-show="state === 'SUCCESS'" class="space-y-2 text-green-400">
            <div class="text-center font-semibold">Report Completed!</div>
            <pre
              x-text="JSON.stringify(result , null , 2)"
              class="text-xs overflow-auto max-h-60 border border-green-700/40 rounded-lg p-3 bg-black/20"
            ></pre>
          </div>

          <div x-show="state === 'FAILURE'" class="space-y-2 text-red-400">
            <div class="text-center font-semibold">Task Failed</div>
            <pre
              x-text="error"
              class="text-xs overflow-auto max-h-60 border border-red-700/40 rounded-lg p-3 bg-black/20"
            ></pre>
          </div>
        </div>
      </section>

      <script>
        function app() {
          return {
            duration: 5,
            taskId: null,
            state: null,
            result: null,
            error: null,
            loading: false,
            intervalId: null,
            async startReport() {
              this.loading = true;
              this.state = null;
              this.error = null;
              this.result = null;
              const response = await axios.post(
                `/reports/heavy-report?duration=${this.duration}`,
              );
              this.taskId = response.data.task_id;
              this.pollTask();
            },
            pollTask() {
              this.intervalId = setInterval(async () => {
                const response = await axios.get(`/tasks/${this.taskId}`);
                this.state = response.data.state;

                if (this.state === "SUCCESS") {
                  this.result = response.data.result;
                  this.loading = false;
                  clearInterval(this.intervalId);
                  return;
                }
                if (this.state === "FAILURE") {
                  this.error = response.data.result;
                  this.loading = false;
                  clearInterval(this.intervalId);
                  return;
                }
              }, 1000);
            },
          };
        }
      </script>
    </main>

    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.2/dist/cdn.min.js"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  </body>
</html>
